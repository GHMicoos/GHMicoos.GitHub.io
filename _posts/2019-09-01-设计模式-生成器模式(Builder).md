---
layout: post
title:  "设计模式 生成器模式（Builder）"
categories: 设计模式
tags: 设计模式 生成器模式 Builder
author: GHMicoos
---


* content
{:toc}

生成器模式：将一个复杂的对象的**构建**与它的表示**分离**，使得同样的构建过程可以创建不同的表示。






### 零 场景问题


#### **0.场景描述**
* 比如说有这么一个数据导出框架，要求导出文本格式、xml格式、json格式的导出文件。
* 对于这个导出框架，对导导出的内容和格式要求如下：
  * 导出文件，无论什么格式，都有三部分组成，文件头、文件体和文件尾。
  * 每个文件的导出内容是一样的，但是内容的展现组织形式不同。
    * 文件头数据包括：公司编号，导出数据时间。
    * 文件体数据包括：表名称，表内容。
    * 文件尾数据部分：导出人。




#### **1.不用模式的解决方案**

``` js

   #region 不用设计模式

    /// <summary>
    /// 描述输出到文件头的内容对象
    /// </summary>
    public class ExportHeaderModel
    {
        /// <summary>
        /// 部门id
        /// </summary>
        public string DeptId { get; set; }

        /// <summary>
        /// 导出时间
        /// </summary>
        public DateTime ExportTime { get; set; }

    }

    /// <summary>
    /// 描述 输出数据对象
    /// </summary>
    public class ExportDataModel
    {
        /// <summary>
        /// 产品id
        /// </summary>
        public string ProductId { get; set; }

        /// <summary>
        /// 产品价格
        /// </summary>
        public decimal Price { get; set; }

        /// <summary>
        /// 销售数量
        /// </summary>
        public double Amount { get; set; }

    }

    /// <summary>
    /// 描述输出到文件尾的内容的对象
    /// </summary>
    public class ExportFooterModel
    {

        /// <summary>
        /// 输出人
        /// </summary>
        public string Exportor { get; set; }
    }

    /// <summary>
    /// 导出数据到txt文件的对象
    /// </summary>
    public class ExportToTxt
    {
        public void Export(ExportHeaderModel header, Dictionary<string, IList<ExportDataModel>> exportDatas, ExportFooterModel footer)
        {


            //1.拼接文件头的内容
            var headerContent = $"导出头：导出部门：{header.DeptId};导出时间：{header.ExportTime.ToString("yyyy-MM-dd")}。";

            //2.拼接文件体内容
            var dataContent = new StringBuilder();
            for (int i = 0, ilen = exportDatas.Keys.Count; i < ilen; i++)
            {

                var tableName = exportDatas.Keys.ElementAt(i);
                var data = exportDatas[tableName];
                dataContent.Append($"表名：{tableName}{Environment.NewLine}");
                for (int j = 0, jlen = data.Count; j < jlen; j++)
                {
                    var product = data[j];
                    dataContent.Append($"数据第{j + 1}行：产品id：{product.ProductId}；价格：{product.Price}；销量：{product.Amount}。{Environment.NewLine}");
                }
            }

            //3.拼接文件尾内容
            var footerContent = $"导出人：{footer.Exportor}。";

            //为了演示的简洁性，这里就不在写出输出文件代码
            //以输出到内容到控制台为演示
            Console.WriteLine("-------------导出到txt文件-开始-------------");
            Console.WriteLine(headerContent);
            Console.WriteLine(dataContent.ToString());
            Console.WriteLine(footerContent);

            Console.WriteLine("-------------导出到txt文件-结束-------------");

        }
    }

    /// <summary>
    /// 导出内容到xml文件的对象
    /// </summary>
    public class ExportToXml
    {
        public void Export(ExportHeaderModel header, Dictionary<string, IList<ExportDataModel>> exportDatas, ExportFooterModel footer)
        {


            //1.拼接文件头的内容
            var headerContent = $"<header><deptId>{header.DeptId}</deptId><exportTime>{header.ExportTime.ToString("yyyy-MM-dd")}<exportTime></header>";

            //2.拼接文件体内容
            var dataContent = new StringBuilder();
            for (int i = 0, ilen = exportDatas.Keys.Count; i < ilen; i++)
            {

                var tableName = exportDatas.Keys.ElementAt(i);
                var data = exportDatas[tableName];
                dataContent.Append($"<tableName>{tableName}{Environment.NewLine}</tableName>");
                dataContent.Append(Environment.NewLine);
                dataContent.Append($"<dataColumn>");
                dataContent.Append(Environment.NewLine);
                for (int j = 0, jlen = data.Count; j < jlen; j++)
                {
                    var product = data[j];
                    dataContent.Append($"<number> { j + 1}</number>");
                    dataContent.Append(Environment.NewLine);
                    dataContent.Append($"<productId>{product.ProductId}<productId>");
                    dataContent.Append(Environment.NewLine);
                    dataContent.Append($"<price>{product.Price}</price>");
                    dataContent.Append(Environment.NewLine);
                    dataContent.Append($"<saleAmount>{product.Amount}</saleAmount>");
                    dataContent.Append(Environment.NewLine);
                }
                dataContent.Append($"</dataColumn>");
                dataContent.Append(Environment.NewLine);
            }

            //3.拼接文件尾内容
            var footerContent = $"<exportor>{footer.Exportor}</exportor>";

            //为了演示的简洁性，这里就不在写出输出文件代码
            //以输出到内容到控制台为演示
            Console.WriteLine("-------------导出到xml文件-开始-------------");
            Console.WriteLine(headerContent);
            Console.WriteLine(dataContent.ToString());
            Console.WriteLine(footerContent);

            Console.WriteLine("-------------导出到xml文件-结束-------------");

        }
    }

    public class BuilderModel_Client
    {
        public void Run()
        {
            var headerData = new ExportHeaderModel()
            {
                DeptId = "地球分公司",
                ExportTime = DateTime.Now,
            };
            var tableData = new Dictionary<string, IList<ExportDataModel>>()
            {
                { "第一周表：",
                   new List<ExportDataModel>()
                   {
                       new ExportDataModel()
                       {
                           ProductId="水果",
                           Price=99.8M,
                           Amount=10,
                       },
                       new ExportDataModel()
                       {
                           ProductId="家电",
                           Price=992.8M,
                           Amount=22,
                       },
                       new ExportDataModel()
                       {
                           ProductId="服饰",
                           Price=929.8M,
                           Amount=59,
                       },
                   }
                },
            };
            var footerData = new ExportFooterModel() { Exportor="张三"};

            var txtExportor = new ExportToTxt();
            txtExportor.Export(headerData,tableData,footerData);
            var xmlExprotor = new ExportToXml();
            xmlExprotor.Export(headerData, tableData, footerData);


        }
    }

    #endregion

```

#### **2.分析**
* 无论输出到什么格式的文件，步骤基本上是一样的，大致分成了以下四步：
  * 拼接文件头内容
  * 拼接文件体内容
  * 拼接文件尾内容
  * 最后把内容输出到文件中
* 也就是说对于不同的输出格式，处理步骤是一样的，但是每个步骤的具体实现是不一样的。

#### **3.存在问题**
* 构建每种输出的文件内容的时候，都会重复处理几个步骤，应该提炼出来形成公共的处理过程.
* 今后可能会有很多不同的输出格式的要求，这就需要在处理过程不变的情况下，能方便地切换不同的输出格式。
* **也就是说，构建数据文件的处理过程，应该和具体的步骤实现分开，这样就能够服用处理过程，而且很容易切换不同的输出格式。**








